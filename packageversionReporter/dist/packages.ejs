<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.0.1/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <title>Package Versions</title>
  <style>
/* Add your CSS here */
body {
  font-family: Arial, sans-serif;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  padding: 0px;
  text-align: left;
  border-bottom: 1px solid #ddd;
  font-size: 12px;
}

th {
  background-color: #4CAF50;
  color: white;
}

th-black {
  background-color: #4CAF50;
  color: black;
}

tr:hover {background-color: #f5f5f5;}

.dt-button {
  font-size: 18px;
  padding: 5px 10px;
}

.diff {
  background-color: #ffc107;
  color: #000;
}

<% datatablesCss %>  /* Inject the DataTables CSS */
</style>
</head>
<body>
  <h1>Package Versions</h1>

  <table id="packageTable">
    <thead>
    <tr>
      <th>PackageName</th>
      <th>Type</th>
      <% environments.forEach((env) => { %>
        <th><%= env %></th>
      <% }); %>
    </tr>
    </thead>
    <tbody>
      <% Object.entries(sortedPackages).forEach(([name, versions]) => { %>
        <tr>
          <td><%= name %></td>
          <td><%= versions[Object.keys(versions)[0]].type || 'N/A' %></td>
          <% environments.forEach((env) => { %>
            <td><%= versions[env] ? versions[env].version : 'N/A' %></td>
          <% }); %>
        </tr>
      <% }); %>
      </tbody>
    </table>

        <div class="modal" tabindex="-1" role="dialog" id="packageModal">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Package Details</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close" id="closeModal">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <table id="packageDetailsTable" class="table-bordered">
                  <thead>
                    <tr>
                      <th>Environment</th>
                      <th>Version</th>
                      <th class="th-black">Subscriber Version</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
         </div>
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    window.sortedPackages = <%- JSON.stringify(sortedPackages) %>;
    window.environments = <%- JSON.stringify(environments) %>;
  </script>
  <script>
    <% datatablesJs %>  /* Inject the DataTables JavaScript */
    <% buttonsJs %>  /* Inject the Buttons JavaScript */
    <% buttonsColVisJs %>  /* Inject the Buttons ColVis JavaScript */
    <% jszip %>  /* Inject the JSZip JavaScript */
    <% pdfmake %>  /* Inject the PDFMake JavaScript */
    <% vfs_fonts %>  /* Inject the vfs_fonts JavaScript */

    $(document).ready(function() {
      $('#packageTable').DataTable({
        dom: 'Bfrtip',
        paginate: false,
        drawCallback: function (settings) {
          var api = this.api();
          api.rows().every(function () {
            var d = this.data();
            var baseValue = null;
            for (var i = d.length - 1; i >= 3; i--) { // Start from the last environment column
              if (d[i] !== 'N/A') {
                baseValue = d[i];
                break;
              }
            }
            if (baseValue !== null) {
              var diffFlag = false;
              for (var i = 3; i < d.length; i++) { 
                if (d[i] !== 'N/A' && d[i] !== baseValue) {
                  // The cell value is different from the baseline
                  // Add the 'diff' class to the cell
                  $(this.node()).find('td:eq(' + i + ')').addClass('diff');  // using string concatenation
                  diffFlag = true;
                }
              }
              // If any differences were found, highlight the package name cell
              if (diffFlag) {
                $(this.node()).find('td:eq(0)').addClass('diff');
              }
            }
            
          });
        }
      });     
      
      
      $('#packageTable').on('click', 'tbody tr', function() {
        const rowData = $('#packageTable').DataTable().row(this).data();
        const packageName = rowData[0];
        const packageData = sortedPackages[packageName];
      
        const detailsTableBody = $("#packageDetailsTable tbody");
        detailsTableBody.empty();
      
        environments.forEach((env) => {
          const data = packageData[env];
          if (data) {
            detailsTableBody.append('<tr><td>' + env + '</td><td>' + data.version + '</td><td>' + data.subscriberVersion + '</td></tr>');
          } else {
            detailsTableBody.append('<tr><td>' + env + '</td><td>N/A</td><td>N/A</td></tr>');
          }
        });
      
        var packageModal = new bootstrap.Modal(document.getElementById('packageModal'));
        packageModal.show();
      });


      document.getElementById('closeModal').addEventListener('click', function() {
        var packageModal = new bootstrap.Modal(document.getElementById('packageModal'));
        packageModal.hide();
      });

    });

 
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
</body>
</html>